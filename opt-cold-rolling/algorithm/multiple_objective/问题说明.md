## 问题背景
现在有一个决策材料在不同工序上的加工顺序问题
背景：
这是一个宏观的生产计划的安排，根据收到的订单进行生产计划的制定，涉及到一到两个月的生产和提前备货
假设：
1. 材料具有钢种、宽度、厚度、重量、交货期属性，0时刻所有材料可以开始生产；
2. 有三道工序，热轧、酸轧、连退，材料在这三道工序上顺序生产，从上一道工序向下一道工序转移需要固定的时间，热轧有一个机器，酸轧有两个机器（处理速度不一样），连退有三个机器（处理速度不一样，每个工序后有一个公共的仓库，用来存放制成品；
3. 最终材料的完成时间是由材料的开始生产时间向后递推得到的
4. 每个机器一旦开始生产就不能停机，直到生产完所有的材料
5. 材料在不同工序上的生产顺序可以不同，这是需要优化的地方
目标：
1. 在热轧工序需要满足钢种相同才能相邻生产，酸轧工序需要满足相邻材料宽度递减，连退工序需要满足相邻材料厚度集中
2. 材料产品最终的交货期尽量不要有拖期的情况
3. 各个工序的仓库库存需要优化

## 一、问题的本质抽象（先定性）

### 1️⃣ 调度结构识别

你的系统可以抽象为：

| 工序 | 机器结构       | 说明            |
| -- | ---------- | ------------- |
| 热轧 | 单机         | 强顺序约束（钢种相同相邻） |            
| 酸轧 | 并行异构机（2 台） | 宽度递减顺序约束      |
| 连退 | 并行异构机（3 台） | 厚度“集中”软约束     |

这属于：

> **Hybrid Flow Shop（混合流水车间）调度问题**

并且具有以下复杂特性：

* 工件（材料）属性驱动的 **相容性约束**
* 工序间 **固定转移时间**
* **非预emptive + 不停机（no-idle）** 约束
* 多目标：交期、库存、工艺切换质量

👉 **这是 NP-hard 问题，不能指望精确算法在工业规模上直接算**

---

## 二、决策变量与约束建模（结构化视角）

### 1️⃣ 核心决策变量

对每个材料 (i)：

* ( \pi^{(h)} )：热轧顺序
* ( \pi^{(a)}_k )：酸轧机 (k) 上的顺序
* ( \pi^{(c)}_m )：连退机 (m) 上的顺序
* ( S_{i,p} )：工序 (p) 的开始时间
* ( C_{i,p} )：工序 (p) 的完成时间

---

### 2️⃣ 关键约束分类

#### （1）工艺流程约束（硬约束）

[
S_{i,a} \ge C_{i,h} + T_{h\to a}
]
[
S_{i,c} \ge C_{i,a} + T_{a\to c}
]

---

#### （2）机器能力 + no-idle 约束（硬）

* 单机/并行机不能重叠
* 每台机器**一旦开机，不允许空转**

这意味着：

> 实际上你不是在“插任务”，而是在**排列整个任务序列**

---

#### （3）工艺相容约束（半硬）

* **热轧**：
  相邻材料钢种必须一致
  → 等价于：热轧顺序只能在钢种分组内部调整

* **酸轧**：
  宽度递减
  → 每台酸轧机上的序列满足
  [
  width_{i_j} \ge width_{i_{j+1}}
  ]

* **连退**：
  厚度集中
  → **软约束（惩罚项）**，如相邻厚度差

---

### 3️⃣ 库存建模（非常关键）

库存不是简单数量，而是**时间积分**

对每道工序后的仓库 (W_p)：

[
Inventory_p(t) = \sum_i \mathbb{1}(C_{i,p} \le t < S_{i,p+1})
]

目标中常用：

* 最大库存
* 库存时间积分
* 或超出阈值的惩罚

---

## 三、目标函数设计（多目标 → 可计算）

你给的目标是典型**冲突目标**，推荐如下处理方式：

### 1️⃣ 主目标（强优先级）

**最小化交期拖期（Tardiness）**

[
\min \sum_i \max(0, C_{i,final} - D_i)
]

---

### 2️⃣ 次目标（工艺稳定性）

* 热轧钢种切换次数（或禁止）
* 酸轧宽度违规惩罚（∞ 或大 M）
* 连退厚度离散度惩罚

---

### 3️⃣ 三目标（库存）

* 各仓库库存峰值
* 或库存时间面积

---

### 4️⃣ 实际工程做法（重要）

不建议直接 Pareto 前沿，**而是层级目标**：

> **Lexicographic / 分层加权目标**

例如：

```text
Priority 1: 总拖期最小
Priority 2: 工艺违规最小
Priority 3: 库存加权最小
```

---

## 四、为什么不能直接用 MILP？

你这个问题如果用 MILP：

* 决策变量：(O(N^2))
* no-idle + 排序 → 大量 big-M
* 并行机 + 属性顺序 → 强非线性

👉 **20–30 个材料就已经不可解**

所以 **工业上一定是“分解 + 启发式 + 元启发式”**

---

## 五、推荐的求解总体框架（工业可落地）

### ✅ 总体策略：**分阶段 + 协同优化**

```
阶段 1：热轧顺序确定（强约束）
阶段 2：酸轧机器分配 + 顺序
阶段 3：连退顺序微调
阶段 4：全局仿真评估（交期 + 库存）
阶段 5：迭代改进
```

---

## 六、各阶段推荐方法

### 🔹 阶段 1：热轧排序（钢种分组）

**问题特点**

* 单机
* 强相容约束

**方法**

* 先按钢种分组
* 组间顺序按：

  * 组内最早交期
  * 或组内总重量

📌 这是**人为规则 + 贪心**即可

---

### 🔹 阶段 2：酸轧（并行异构机 + 宽度递减）

这是难点之一。

#### 建模方式

* 每台机器只能处理一个**宽度单调递减子序列**
* 类似 **多链划分问题**

#### 推荐算法

**（1）贪心 + 修复**

* 按宽度降序遍历材料
* 分配给“最早可用 + 最不破坏交期”的机器

**（2）局部搜索**

* 邻域：

  * 交换两台机器的相邻块
  * 在同一台机器内微调顺序

---

### 🔹 阶段 3：连退（厚度集中）

连退更像：

> **Clustering + Sequencing**

方法：

* 先按厚度聚类（K-means / 分段）
* 每个簇分配到一台连退机
* 簇内按交期排序

---

### 🔹 阶段 4：全流程仿真评估（非常重要）

每一个解都必须：

* 正向时间推进
* 计算真实完工时间
* 统计库存曲线
* 输出指标

👉 **没有仿真，就谈不上优化**

---

## 七、全局优化算法选择（推荐）

在上述框架上，用元启发式“包住”：

### ⭐ 推荐：NSGA-II

* 解编码：

  * 热轧顺序
  * 酸轧机器 + 顺序
  * 连退顺序
* 目标：拖期 + 库存 + 工艺惩罚



